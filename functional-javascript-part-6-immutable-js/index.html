<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!--Description-->
  
  <meta name="description" content="In the previous post we saw some techniques that can help us implement immutability. However, none of them feel very natural in plain, vanilla JavaScr">
  

  <!--Author-->
  
  <meta name="author" content="Mi≈Çosz Piechocki">
  

  <!--Open Graph Title-->
  
  <meta property="og:title" content="Functional JavaScript part 6: immutable.js">
  

  <!--Open Graph Description-->
  

  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="codewithstyle.info">

  <!--Type page-->
  
  <meta property="og:type" content="article">
  

  <!--Page Cover-->
  
  <meta name="twitter:card" content="summary">
   

  <!-- Title -->
  
  <title>Functional JavaScript part 6: immutable.js - codewithstyle.info</title>

  <!-- Tachyons Core CSS -->
  <link rel="stylesheet" href="//unpkg.com/tachyons/css/tachyons.min.css">

  <!-- Custom Fonts -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

  
  <link rel="amphtml" href="https://codewithstyle.info/functional-javascript-part-6-immutable-js//amp/index.html">
  

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/style.css">

  <!-- Google Analytics -->
  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-89535231-1', 'auto');
        ga('send', 'pageview');

    </script>



  <!-- Twitter -->
  <script>
    window.twttr = (function (d, s, id) {
      var js,
        fjs = d.getElementsByTagName(s)[0],
        t = window.twttr || {};
      if (d.getElementById(id)) return t;
      js = d.createElement(s);
      js.id = id;
      js.src = "https://platform.twitter.com/widgets.js";
      fjs.parentNode.insertBefore(js, fjs);

      t._e = [];
      t.ready = function (f) {
        t._e.push(f);
      };

      return t;
    })(document, "script", "twitter-wjs");
  </script>

  <!-- MailerLite Universal -->
  <script>
    (function (m, a, i, l, e, r) {
      m["MailerLiteObject"] = e;
      function f() {
        var c = { a: arguments, q: [] };
        var r = this.push(c);
        return "number" != typeof r ? r : f.bind(c.q);
      }
      f.q = f.q || [];
      m[e] = m[e] || f.bind(f.q);
      m[e].q = m[e].q || f.q;
      r = a.createElement(i);
      var _ = a.getElementsByTagName(i)[0];
      r.async = 1;
      r.src = l + "?v" + ~~(new Date().getTime() / 1000000);
      _.parentNode.insertBefore(r, _);
    })(
      window,
      document,
      "script",
      "https://static.mailerlite.com/js/universal.js",
      "ml"
    );

    var ml_account = ml("accounts", "1785990", "w8k8t0a5z1", "load");
  </script>
  <!-- End MailerLite Universal -->
</head>


<body>

<!-- Main Content -->
<!-- Banner -->
<!-- Banner -->
<div class="w-100 bg-1 text-light">
  <div class="w-100">
    <nav class="db flex-l pv3 mw8 center items-center-l">
      <a class="db v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="codewithstyle.info">
        <img src="/images/2017/07/CODE-WITHSTYLE-1.png" class="dib h3" alt="codewithstyle.info">
      </a>
      <div class="db v-mid w-100 w-75-l tc tr-l">
        
        <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/toc" title="Table of Contents">
          Table of Contents
        </a>
        
        <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/tags/typescript" title="TypeScript">
          TypeScript
        </a>
        
        <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/functional-programming" title="Functional Programming">
          Functional Programming
        </a>
        
        <a class="link dim f6 f5-l dib mr3 mr4-l white" href="http://miloszpiechocki.com/" title="Author">
          Author
        </a>
        
      </div>
    </nav>
  </div>

  <!-- Title -->
  <div class="w-100 vh-40 dt" style="background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)),
    url('images/homepage.png'); background-size: cover; background-position: center">
    <div class="v-mid white center mw8">
      <h1 class="f1-l f2-m tc tc-m tl-ns">Functional JavaScript part 6: immutable.js</h1>
      <p class="f4 fw3 pab-100px tc tc-m tl-ns">2017-08-24</p>
    </div>
  </div>

  <div class="w-100 bt">
    <section class="pa2 mw8 center white">
      <a class="link white dim" href="https://typescriptmasterclass.com">
        üî• Check out my <em>Advanced TypeScript Masterclass book</em> üî•
      </a>
    </section>
  </div>
</div>


<!-- Content -->
<div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l">
    <div class="content">
        <div class="mw8 center">
            <div class="cf">
                <div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content">
                    <!-- Tags Vertical -->
                    
                        <div class="tags-container-vertical">
                            <div class="tags-sub-container">
                                <a class="fw3 ph1 dib" href="/tags/functional-programming/">#functional programming</a> <a class="fw3 ph1 dib" href="/tags/immutability/">#immutability</a>
                            </div>
                        </div>
                    

                    <!-- Main Post Content -->
                    <p>In the previous post we saw some techniques that can help us implement immutability. However, none of them feel very natural in plain, vanilla JavaScript. It doesn‚Äôt feel like the language and the standard library have been designed with immutability in mind. It‚Äôs not surprising given that one of the language‚Äôs main purposes was to <strong>mutate</strong> DOM (the Document Object Model). </p>
<p><img src="/images/2017/08/Zrzut-ekranu-2017-08-24-o-21.54.50-300x70.png" alt=""> </p>
<p>Fortunately, <a href="https://facebook.github.io/immutable-js/" target="_blank" rel="noopener">Immutable.js</a> comes to rescue. It is a library which makes working immutable objects much more natural. In this post we will learn how to use the library and how we can benefit from it. </p>
<p><strong>This post is part of the <a href="https://codewithstyle.info/functional-programming-javascript-plain-words/">Functional Programming in JavaScript series</a>.</strong></p>
<h3 id="Map-instead-of-object"><a href="#Map-instead-of-object" class="headerlink" title="Map instead of object"></a>Map instead of object</h3><p>Immutable.js introduces a few immutable data structures. Let‚Äôs focus on Map  which is an immutable version of plain JavaScript object. The name comes from the world of algorithms and data structures where we use it as a name for a structure which <em>maps</em> some keys to some values (just like a JavaScript object). It‚Äôs very easy to initialize a Map from a plain JavaScript object:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> product = Immutable.Map(&#123; <span class="attr">name</span>: <span class="string">"Product"</span>, <span class="attr">quantity</span>: <span class="number">10</span> &#125;);</span><br></pre></td></tr></table></figure>
<p>We must not use assignment operator with a Map object‚Äôs properties. Instead, we should call the set  method on it.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> product = Immutable.Map(&#123; <span class="attr">name</span>: <span class="string">"U-lock"</span>, <span class="attr">quantity</span>: <span class="number">10</span> &#125;);</span><br><span class="line"><span class="keyword">const</span> updatedProduct = product.set(<span class="string">"category"</span>, <span class="string">"safety"</span>);</span><br></pre></td></tr></table></figure>
<p>As expected set will not mutate the original object. Instead, it will return a new updated object. We can easily return to the world of plain JavaScript objects with toJS:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updatedProduct.toJS();</span><br></pre></td></tr></table></figure>
<h3 id="Nested-objects"><a href="#Nested-objects" class="headerlink" title="Nested objects"></a>Nested objects</h3><p>There are many interesting operations available on Map. For example, setIn works great with deeply nested objects. Imagine having an object with several levels of nesting and having to update a property residing in a deeply nested object.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> employee = &#123;</span><br><span class="line">  name: <span class="string">"John"</span>,</span><br><span class="line">  reportsTo: &#123;</span><br><span class="line">    name: <span class="string">"Alice"</span>,</span><br><span class="line">    reportsTo: &#123;</span><br><span class="line">      name: <span class="string">"Bob"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> immutableEmployee = Immutable.fromJS(employee);</span><br><span class="line"><span class="keyword">const</span> updatedEmployee = immutableEmployee.setIn([<span class="string">"reportsTo"</span>, <span class="string">"reportsTo"</span>], <span class="string">"Celine"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(updatedEmployee.toJS());</span><br></pre></td></tr></table></figure>
<p>First of all, note that we‚Äôve used fromJS  instead of Map . This is because Map only works shallowly - when it sees a property that‚Äôs a reference to an object it doesn‚Äôt convert it to Map but jest leaves it as it is. On the other hand fromJS  will always traverse all levels of nesting. As you can see setIn takes an array of strings defining the path of properties leading to the value we are interested in. The second argument is the value we want to set the property to. Obviously setIn doesn‚Äôt mutate the object but returns a fresh copy instead.</p>
<h3 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h3><p>We haven‚Äôt yet discussed immutability of arrays. In the previous chapters we‚Äôve talked about how to avoid mutating objects. What about arrays? Basic array operations in vanilla JavaScript are mutable - they update the array in-place:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">numbers.push(<span class="number">5</span>);</span><br></pre></td></tr></table></figure>
<p>An immutable version of push would have to clone the array first and add the element to the new copy. We‚Äôve already discussed a similar approach when talking about sort in the <a href="https://codewithstyle.info/functional-javascript-part-4-lodash/">chapter about lodash</a>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">immutablePush</span>(<span class="params">arr, newElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> arrCopy = arr.slice(<span class="number">0</span>);</span><br><span class="line">  arrCopy.push(newElement);</span><br><span class="line">  <span class="keyword">return</span> arrCopy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The ES6 spread operator lets us do this in a more concise way. It‚Äôs like the object spread operator - it ‚Äúunwraps‚Äù array elements and lets you put them directly in another list.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> newNumbers = [...numbers, <span class="number">7</span>];</span><br></pre></td></tr></table></figure>
<p>But how about adding an element in the middle of an array? It gets a little messy.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> newNumbers = [...numbers.slice(<span class="number">0</span>, <span class="number">2</span>), <span class="number">7</span>, ...numbers.slice(<span class="number">3</span>)];</span><br></pre></td></tr></table></figure>
<p>Immutable.js simplifies immutable array operations by introducing a List object. List has methods similar to array‚Äôs but all of them are immutable and return a fresh copy instead of mutating the list.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> numbersList = Immutable.List([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"><span class="keyword">const</span> newNumbersList = numbersList.insert(<span class="number">2</span>, <span class="number">99</span>);</span><br></pre></td></tr></table></figure>
<p>List has many useful methods which make working with it in immutable way easier than working with arrays.</p>
<h3 id="Structural-sharing"><a href="#Structural-sharing" class="headerlink" title="Structural sharing"></a>Structural sharing</h3><p>We haven‚Äôt touched on an important drawback of immutability yet - performance. Cloning objects in JavaScript is expensive. With immutability we have to use cloning a lot since we aren‚Äôt allowed to mutate objects. This is especially painful if you have to deal with large objects and only want to update a single property. In such case you would need to re-create the whole object anyway. Fortunately, Immutable.js tries to address the issue by using various optimization techniques including <strong>structural sharing</strong>. It stores Maps in such a way that when you update some property you get a reference to a new Map which shares some of the data with the old Map. Since Maps are immutable this isn‚Äôt a problem - we don‚Äôt need to worry that the shared part will be accidentaly modified.</p>
<h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h3><p>I have created a benchmark in order to measure the performance of Immutable.js. In this benchmark I create an array of 100000 moderately complex objects. Next, I compare the performance of changing a single property of this object in one of 3 ways:</p>
<ol>
<li>Simply mutate the object (the mutable way) - <strong>224 test runs/second</strong></li>
<li>Deep clone using spread operator - <strong>2.36 test runs/second</strong></li>
<li>Clone using Immutable.js - <strong>4.97 test runs/second</strong></li>
</ol>
<p>We can see that all immutable options are much, much slower than simply mutating the object. This is because of the cost of cloning objects. However, we can also see that cloning with Immutable.js is two times faster than using the spread operator. The benchmark does not take into consideration the fact that in order to use Immutable.js our array of objects had to be converted into an array of Maps which is a quite expensive operation. The results would be much worse in such case. Therefore, it makes sense to use Immutable.js all the way throughout your application in order to avoid converting between Immutable.js data structures and vanilla JavaScript data structures. The benchmark is publicly available. Feel free to play with it: <a href="https://jsperf.com/immutability-performance-nested-objects/1" target="_blank" rel="noopener">https://jsperf.com/immutability-performance-nested-objects/1</a></p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>This post was a quick introduction to Immutable.js. We‚Äôve learned about immutable data structures such as Map and List, how to perform operations on them and how Immutable.js approaches performance issues related to immutability. It‚Äôs understandable if the posts about Immutability seem a little abstract so far. In the next post we will fix it - you will see how useful can it be on an example of Redux. If you have any issues understanding anything in this post or if you simply would like to provide feedback, please leave a comment below. I want this course to be as good as possible and I need your help for that! If you found this post helpful, please consider sharing it on Facebook or Twitter.</p>


                    


                    <div class="social-sharing pv3">
                      <h5 class="mv1">Enjoyed it? Let others hear about it too! ‚ù§Ô∏è</h5>
                      <div class="flex items-center">
                        <a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=Functional JavaScript part 6: immutable.js by @miloszpp" data-size="large">
                          Tweet
                        </a>
                        <div class="fb-share-button mh1" data-href="387.html" data-layout="button_count" data-size="large">
                        </div>
                      </div>
                    </div>
                    
                    <!-- Tags Bottom -->
                    
                        <div class="tags-container-bottom">
                            <i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/tags/functional-programming/">#functional programming</a> <a class="fw3 ph1 dib" href="/tags/immutability/">#immutability</a>
                        </div>
                    

                    <!-- Comments -->
                    
<div id="disqus_thread" class="mt5">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>



                    

                </div>
                <div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50">
                <hr class="dn-l mw4 black-50 mt5">

<div class="mt5 mt0-l">
    <article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3">
        <div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width: 6rem;">
            <img src="/images/speaker-avatar-2.png" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="Mi≈Çosz Piechocki">
        </div>
        <div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">
            Hi! My name is Mi≈Çosz Piechocki. I‚Äôm a software developer living in Warsaw, Poland. I‚Äôm passionate about TypeScript, JavaScript and functional programming in modern web development.
        </div>
        <div class="mt3">
          <a class="twitter-follow-button" data-show-count="false" href="https://twitter.com/miloszpp">
            Follow me on Twitter</a>
        </div>
    </article>
</div>

<hr class="dn-l mw4 black-50 mt5">

<div class="mt5 tc tl-l">
  <h3>Free download</h3>
  <a href="/10tips"><img src="/images/10tips.png"></a>
</div>

<hr class="dn-l mw4 black-50 mt5">

                </div>
            </div>
        </div>
    </div>
</div>


<!-- Footer -->
<div class="bg-1 ph2 ph5-ns pv5">
    <div class="mv8">
        <div class="center tc">
            
                <div class="dib mh3">
                    <a class="f3 f2-ns white dim" href="http://twitter.com/miloszpp/" target="_blank">
                        <i class="fab fa-twitter"></i>
                    </a>
                </div>
            
                <div class="dib mh3">
                    <a class="f3 f2-ns white dim" href="http://facebook.com/codewithstyle.info/" target="_blank">
                        <i class="fab fa-facebook"></i>
                    </a>
                </div>
            
                <div class="dib mh3">
                    <a class="f3 f2-ns white dim" href="https://github.com/miloszpp" target="_blank">
                        <i class="fab fa-github"></i>
                    </a>
                </div>
            
                <div class="dib mh3">
                    <a class="f3 f2-ns white dim" href="https://www.youtube.com/channel/UC_DEBDpgRyBZAT85tJ1QZBw" target="_blank">
                        <i class="fab fa-youtube"></i>
                    </a>
                </div>
            
                <div class="dib mh3">
                    <a class="f3 f2-ns white dim" href="mailto:milosz@miloszpiechocki.com" target="_blank">
                        <i class="fas fa-envelope"></i>
                    </a>
                </div>
            
                <div class="dib mh3">
                    <a class="f3 f2-ns white dim" href="/atom.xml" target="_blank">
                        <i class="fas fa-rss"></i>
                    </a>
                </div>
            
        </div>
        <div class="f6 f5-ns center tc white pt5 fw3">
            @Copyright Mi≈Çosz Piechocki. All right reserved | Design & Hexo based on Anodyne by <a class="link dim white" href="http://www.codeblocq.com/">Jonathan Klughertz</a>
        </div>
    </div>
</div>

  <!-- Load Facebook SDK for JavaScript -->
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>

<!-- After Footer -->
<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'codewithstyle';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>

</html>