<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="This post is another attempt on explaining the M word in an approachable way. This explanation will best suite C# developers who are familiar with LIN">
    

    <!--Author-->
    
        <meta name="author" content="Miłosz Piechocki">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Understand monads with LINQ">
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="codewithstyle.info">

    <!--Type page-->
    
        <meta property="og:type" content="article">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>Understand monads with LINQ - codewithstyle.info</title>

    <!-- Tachyons Core CSS -->
    <link rel="stylesheet" href="//unpkg.com/tachyons/css/tachyons.min.css">

    <!-- Custom Fonts -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<!-- Main Content -->
<!-- Banner -->
<!-- Banner -->
<div class="w-100 bg-1 text-light">
    
    <div class="w-100">
        <nav class="db flex-l pv3 mw8 center items-center-l">
            <a class="db v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="codewithstyle.info">
                <img src="https://codewithstyle.info/wp-content/uploads/2017/07/CODE-WITHSTYLE-1.png" class="dib h3" alt="codewithstyle.info">
            </a>
            <div class="db v-mid w-100 w-75-l tc tr-l">
                
                    <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">
                        Home
                    </a>
                
                    <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/functional-programming" title="Functional Programming">
                        Functional Programming
                    </a>
                
                    <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">
                        Archives
                    </a>
                
                    <a class="link dim f6 f5-l dib mr3 mr4-l white" href="http://miloszpiechocki.com/" title="Author">
                        Author
                    </a>
                
            </div>
        </nav>
    </div>

    <!-- Title -->
    <div class="w-100 vh-40 dt">
        <div class="v-mid white center mw8">
            <h1 class="f1-l f2-m tc tc-m tl-ns">Understand monads with LINQ</h1>
            <p class="f4 fw3 pab-100px tc tc-m tl-ns">2017-03-18</p>
        </div>
    </div>

    <!-- Icon -->
    <div class="relative w-100 mw8 center white dn dn-m db-ns">
        <i class="header-icon "></i>
    </div>
</div>

<!-- Content -->
<div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l">
    <div class="content">
        <div class="mw8 center">
            <div class="cf">
                <div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content">
                    <!-- Tags Vertical -->
                    
                        <div class="tags-container-vertical">
                            <div class="tags-sub-container">
                                <a class="fw3 ph1 dib" href="/tags/c/">#c#</a> <a class="fw3 ph1 dib" href="/tags/functional-programming/">#functional programming</a>
                            </div>
                        </div>
                    

                    <!-- Main Post Content -->
                    <p>This post is another attempt on explaining <strong>the M word</strong> in an approachable way. This explanation will best suite C# developers who are familiar with LINQ and query expressions. However, if you are not familiar with C# but would like to learn how powerful and expressive some of its features are, please read on!</p>
<h3 id="Recap-of-LINQ-and-query-expressions"><a href="#Recap-of-LINQ-and-query-expressions" class="headerlink" title="Recap of LINQ and query expressions"></a>Recap of LINQ and query expressions</h3><p>LINQ is a technology introduced in C# 3.0 and .NET 3.5. One of its major applications is processing collections in an elegant, declarative way. Here’s an example of LINQ’s s_elect_ expression:</p>
<p>var numbers = new[] { 1, 2, 3, 4, 5 };<br>var squares = numbers.Select(x =&gt; x * x);</p>
<p>Query expressions are one of the language features which constitute LINQ. Thanks to it LINQ expressions can look in a way which resembles SQL expressions:</p>
<p>var squares = from x in numbers select x * x;</p>
<p>Before LINQ you would need to write a horrible, imperative loop which literates over the <em>numbers</em> array and appends the results to a new array.</p>
<h3 id="Single-element-collection-Maybe-class"><a href="#Single-element-collection-Maybe-class" class="headerlink" title="Single element collection: Maybe class"></a>Single element collection: Maybe class</h3><p>It’s pretty easy to understand what <em>select</em> expression does in the above example: it apples a given expression to each element of a collection and produces a collection containing the results. Let’s now imagine that instead of arbitrary collection, we are working with a special kind of collection - one that can have either one element or no elements at all. In other words, it’s either empty, or full. How should <em>select</em> expression act on such a collection? Exactly the same way that it works with regular collections. If our collection has one element than apply the given expression to it and return a new collection with the result. If the collection is empty, just return an empty collection. Note that such a special collection is actually quite interesting - it represents an object that either has a value or is empty. Let’s create such an object and call it <em>Maybe</em>.</p>
<p>public class Maybe<tvalue><br>{<br>    private readonly TValue value;<br>    private readonly bool hasValue;</tvalue></p>
<pre><code>internal Maybe(TValue value, bool hasValue)
{
    this.value = value;
    this.hasValue = hasValue;
}
</code></pre><p>}</p>
<p>Let’s create two factory methods to allow more convenient creation of instances of <em>Maybe</em>.</p>
<p>public static class MaybeFactory<br>{<br>    public static Maybe<t> Some<t>(T value) =&gt; new Maybe<t>(value, true);</t></t></t></p>
<pre><code>public static Maybe&lt;T&gt; None&lt;T&gt;() =&gt; new Maybe&lt;T&gt;(default(T), false);
</code></pre><p>}</p>
<p>Thanks to type inference in generic method calls and the <strong>static using</strong>feature we can now simply write:</p>
<p>var some = Some(10);<br>var none = None<int>();</int></p>
<h3 id="Making-Maybe-LINQ-friendly"><a href="#Making-Maybe-LINQ-friendly" class="headerlink" title="Making Maybe LINQ-friendly"></a>Making Maybe LINQ-friendly</h3><p>Since we’ve already discussed how <em>select</em> would work on <em>Maybe</em>, let’s implement it! Adding support for query expressions to your custom types is surprisingly easy. You just need to define a method which confirms to a specific signature (it’s an interesting design decision by C# creators which allows more flexibility than requiring the type to implement a specific interface).</p>
<p>public Maybe<tresult> Select<tresult>(Func&lt;TValue, TResult&gt; mapperExpression)<br>{<br>    if (this.hasValue)<br>    {<br>        return MaybeFactory.Some(mapperExpression(this.value));<br>    }<br>    return MaybeFactory.None<tresult>();<br>}</tresult></tresult></tresult></p>
<p>What’s going on here? Firstly, let’s take a look at the signature. Our method takes a function which transforms the value contained by <em>Maybe</em> to another type.  It returns an instance of <em>Maybe</em> containing an instance of the result type. If it’s confusing, just replace <em>Maybe</em> with <em>List</em> or _IEnumerable. _It makes perfect sense to write a <em>select</em> expression which transforms a list of <em>ints</em> to a list of <em>strings</em>. It works the same way with our <em>Maybe</em> type. <img src="http://codewithstyle.info/wp-content/uploads/2017/03/select-1.png" alt="" title="select"> Now, the implementation. There are two cases:</p>
<ul>
<li>If the object contains a value than apply the <em>mapper</em> function and return a new <em>Maybe</em> instance with the result</li>
<li>If the object is empty, there is nothing to convert - return a new empty <em>Maybe</em> instance</li>
</ul>
<p>Let’s give it a try:</p>
<p>Maybe<int> age = Some(27);<br>Maybe<string> result = from x in age select string.Format(“I’am {0} years old”, x);</string></int></p>
<p>Nice! We can now use <em>select</em> expressions with <em>Maybe</em> type.</p>
<h3 id="Taking-it-one-step-further"><a href="#Taking-it-one-step-further" class="headerlink" title="Taking it one step further"></a>Taking it one step further</h3><p>Let’s now imagine that given an employee’s id, our goal is to return the name of theirs supervisor’s supervisor. A person can but does not have to have a supervisor. We are given a repository class with the following method:</p>
<p>public Person GetPersionById(Guid id) { … }</p>
<p>And a <em>Person</em> class:</p>
<p>class Person<br>{<br>    public string Name { get; set; }<br>    public Person ReportsTo { get; set; }<br>}</p>
<p>In order to find the person’s supervisor’s supervisor’s name we would need to write a series of _if_ statements:</p>
<p>public static string GetSupervisorSupervisorName(Person employee)<br>{<br>    if (employee != null)<br>    {<br>        if (employee.ReportsTo != null)<br>        {<br>            if (employee.ReportsTo.ReportsTo != null)<br>            {<br>                return employee.ReportsTo.ReportsTo.Name;<br>            }<br>        }<br>    }</p>
<pre><code>return null;
</code></pre><p>}</p>
<p>Can we improve this code with our new <em>Maybe</em> type? Of course we can! First of all, since <em>Maybe</em> represents a value which may or may not exist, it seems reasonable for <em>GetPersonById</em> to return <em>Maybe<person></person></em> instead of <em>Person</em>.</p>
<p>public static Maybe<person> GetPersonById(Guid id)</person></p>
<p>Next, let’s modify the <em>Person</em> class. Since a person can either have or not have a supervisor, it’s again a good fit for the <em>Maybe</em> type:</p>
<p>class MonadicPerson<br>{<br>    public string Name { get; set; }<br>    public Maybe<monadicperson> ReportsTo { get; set; }<br>}</monadicperson></p>
<p>Given these modifications we can now rewrite <em>GetSupervisorSupervisorName</em> in a neater and more elegant way:</p>
<p>public static Maybe<string> GetSupervisorName(Maybe<monadicperson> maybeEmployee)<br>{<br>    return from employee in maybeEmployee<br>           from supervisor in employee.ReportsTo<br>           from supervisorSupervisor in supervisor.ReportsTo<br>           select supervisorSupervisor.Name;<br>}</monadicperson></string></p>
<p>Why is this better than the previous version? First of all, we explicitly represent the fact that given a person, the method might or might not return a valid result. Previously, the method always returned a <em>string</em>. There was no way to indicate that it can sometimes return <em>null</em> (apart from a comment). A user of such a method could forget to perform null check and in consequence be surprised by a runtime error. What’s more, we avoid the nesting of if statements. In this example we only go two levels deep. What if there were 5 levels? Code without these nested if statements is much cleaner and more readable. It expresses the actual logic, not on the boilerplate of null-checking.</p>
<h3 id="Making-it-work"><a href="#Making-it-work" class="headerlink" title="Making it work"></a>Making it work</h3><p>If you’re copying these snippets to Visual Studio, you might have noticed that the last one won’t compile. By implementing <em>Select</em> we told the compiler how to apply functions to values inside <em>Maybe</em> instances. However, here we have a slightly more complex situation. We take a value which sits inside a <em>Maybe</em> instance and apply a function to it. As a result we get another <em>Maybe</em> instance, so now we have a <em>Maybe</em> inside a <em>Maybe</em>. The compiler doesn’t know how to handle this situation and we need to tell it by implementing <em>SelectMany</em>.</p>
<p>public Maybe<tresult> SelectMany&lt;TIntermediate, TResult&gt;(<br>    Func&lt;TValue, Maybe<tintermediate>&gt; mapper,<br>    Func&lt;TValue, TIntermediate, TResult&gt; getResult<br>)<br>{<br>    if (this.hasValue)<br>    {<br>        var intermediate = mapper(this.value);<br>        if (intermediate.hasValue)<br>        {<br>            return MaybeFactory.Some(getResult(this.value, intermediate.value));<br>        }<br>    }<br>    return MaybeFactory.None<tresult>();<br>}</tresult></tintermediate></tresult></p>
<p>The first parameter to <em>SelectMany</em> is a function which takes a value (which sits inside <em>Maybe</em>) and returns a new <em>Maybe</em>. In our example, that would be a function which takes a <em>Person</em> and returns its <em>ReportsTo</em> property. The second parameter is a function which takes the original value, the value sitting inside <em>Maybe</em> returned by the first parameter and transforms both into a result. In our case that would be a function which takes a <em>Person</em> and returns its <em>Name</em>. Inside the implementation we have the nested if statements that we had to write when we didn’t use the _Maybe _type. And this is the crucial idea about monads - they help you hide ugly boilerplate code and let the developer focus on the actual logic. Again, let me draw a diagram for those of you who prefer visual aids: <img src="http://codewithstyle.info/wp-content/uploads/2017/03/SelectMany.png" alt="" title="SelectMany"></p>
<h3 id="Ok-so-what’s-exactly-a-Monad"><a href="#Ok-so-what’s-exactly-a-Monad" class="headerlink" title="Ok, so what’s exactly a Monad?"></a>Ok, so what’s exactly a Monad?</h3><p>Monad is any generic type which implements _SelectMany _(strictly speaking, this is far from a formal definition, but I think it’s sufficient in this context and captures the core idea). <em>SelectMany</em> is a slightly more general version of an operation which in the functional programming world is referred to as <strong>bind</strong>. Monadic types are like wrappers around some values. Binding monads is all about composing them. By wrapping and unwrapping of the values inside monads, we can perform additional operations (such as handling empty results in our case) and hide them away from the user. <em>Maybe</em> is a classic example of a monad. Another great candidate for monad is C#’s <em>Task<t></t></em> type. You can think of it as a type that wraps some value (the one that will be returned when the task completes). By combining tasks you describe that one task should be executed after the other finishes.</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>I hope this article helped you understand what monads are about. If you find this interesting, check out the F# programming language where monads are much more common and feel more natural. Check out this excellent resource about F#: <a href="https://fsharpforfunandprofit.com/" target="_blank" rel="noopener">https://fsharpforfunandprofit.com/</a>. It’s also worth mentioning that there exists an interesting C# library which exploits the concepts I described in this article: <a href="https://github.com/louthy/csharp-monad" target="_blank" rel="noopener">https://github.com/louthy/csharp-monad</a>. Check it out if you’re interested.</p>

                    
                    <!-- Tags Bottom -->
                    
                        <div class="tags-container-bottom">
                            <i class="fa fa-tag pr3 text-main-color"></i><a class="fw3 ph1 dib" href="/tags/c/">#c#</a> <a class="fw3 ph1 dib" href="/tags/functional-programming/">#functional programming</a>
                        </div>
                    

                    <!-- Comments -->
                    



                </div>
                <div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50">
                    
                    <hr class="dn-l mw4 black-50 mt5">
                    
                    <div class="mt5 mt0-l">
    <article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3">
        <div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width: 6rem;">
            <img src="https://codewithstyle.info/wp-content/uploads/2017/02/miloszpiechocki.jpeg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="Miłosz Piechocki">
        </div>
        <div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">
            Hi! My name is Miłosz Piechocki. I’m a software developer living in Warsaw, Poland. I’m passionate about functional programming and in particular how it’s applied in modern web technologies.
        </div>
    </article>
</div>

                    <hr class="dn-l mw4 black-50 mt5">

                    <div class="mt5 tc tl-l">
    <h3>Download free e-book</h3>
    <p class="tj f6 lh-copy">Subscribe to receive updates about new posts and I will send you a link to a free e-book about functional programming in JavaScript.</p>
    <!-- Begin Mailchimp Signup Form -->
    <div id="mc_embed_signup">
        <form action="https://codewithstyle.us15.list-manage.com/subscribe/post?u=9387aca2477532e2e033cee17&amp;id=7c51853ca5" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
            <div id="mc_embed_signup_scroll">
                <div class="mc-field-group">
                    <input class="pa2 input-reset ba bg-transparent w-100" type="email" value="" name="EMAIL" id="mce-EMAIL" placeholder="enter your email">
                </div>
                <div id="mce-responses" class="clear">
                    <div class="response" id="mce-error-response" style="display:none"></div>
                    <div class="response" id="mce-success-response" style="display:none"></div>
                </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9387aca2477532e2e033cee17_7c51853ca5" tabindex="-1" value=""></div>
                <div class="clear mt2">
                    <input class="b ph3 pv2 input-reset ba b--black bg-transparent grow pointer f6 dib" type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe">
                </div>
            </div>
        </form>
    </div>
    <!--End mc_embed_signup-->
</div>

                    
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Footer -->
<div class="bg-1 ph2 ph5-ns pv5">
        <div class="mv8">
            <div class="center tc">
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="http://twitter.com/miloszpp/" target="_blank">
                            <i class="fab fa-twitter"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="http://facebook.com/codewithstyle.info/" target="_blank">
                            <i class="fab fa-facebook"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://github.com/miloszpp" target="_blank">
                            <i class="fab fa-github"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://www.youtube.com/channel/UC_DEBDpgRyBZAT85tJ1QZBw" target="_blank">
                            <i class="fab fa-youtube"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="mailto:milosz@miloszpiechocki.com" target="_blank">
                            <i class="fas fa-envelope"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="/#" target="_blank">
                            <i class="fas fa-rss"></i>
                        </a>
                    </div>
                
            </div>
            <div class="f6 f5-ns center tc white pt5 fw3">
                @Copyright Miłosz Piechocki. All right reserved | Design & Hexo based on Anodyne by <a class="link dim white" href="http://www.codeblocq.com/">Jonathan Klughertz</a>
            </div>
        </div>
    </div>

<!-- After Footer -->
<!-- Disqus Comments -->



</body>

</html>