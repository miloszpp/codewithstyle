<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="In the previous post I’ve explained what discriminated unions are in the TypeScript language. We’ll now look into a classic example of how this concep">
    

    <!--Author-->
    
        <meta name="author" content="Miłosz Piechocki">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="TypeScript: Building an interpreter with discriminated unions">
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="codewithstyle.info">

    <!--Type page-->
    
        <meta property="og:type" content="article">
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary">
    

    <!-- Title -->
    
    <title>TypeScript: Building an interpreter with discriminated unions - codewithstyle.info</title>

    <!-- Tachyons Core CSS -->
    <link rel="stylesheet" href="//unpkg.com/tachyons/css/tachyons.min.css">

    <!-- Custom Fonts -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<!-- Main Content -->
<!-- Banner -->
<!-- Banner -->
<div class="w-100 bg-1 text-light">
    
    <div class="w-100">
        <nav class="db flex-l pv3 mw8 center items-center-l">
            <a class="db v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="codewithstyle.info">
                <img src="https://codewithstyle.info/wp-content/uploads/2017/07/CODE-WITHSTYLE-1.png" class="dib h3" alt="codewithstyle.info">
            </a>
            <div class="db v-mid w-100 w-75-l tc tr-l">
                
                    <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/" title="Home">
                        Home
                    </a>
                
                    <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/functional-programming" title="Functional Programming">
                        Functional Programming
                    </a>
                
                    <a class="link dim f6 f5-l dib mr3 mr4-l white" href="/archives" title="Archives">
                        Archives
                    </a>
                
                    <a class="link dim f6 f5-l dib mr3 mr4-l white" href="http://miloszpiechocki.com/" title="Author">
                        Author
                    </a>
                
            </div>
        </nav>
    </div>

    <!-- Title -->
    <div class="w-100 vh-40 dt">
        <div class="v-mid white center mw8">
            <h1 class="f1-l f2-m tc tc-m tl-ns">TypeScript: Building an interpreter with discriminated unions</h1>
            <p class="f4 fw3 pab-100px tc tc-m tl-ns">2018-01-17</p>
        </div>
    </div>

    <!-- Icon -->
    <div class="relative w-100 mw8 center white dn dn-m db-ns">
        <i class="header-icon "></i>
    </div>
</div>

<!-- Content -->
<div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l">
    <div class="content">
        <div class="mw8 center">
            <div class="cf">
                <div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content">
                    <!-- Tags Vertical -->
                    

                    <!-- Main Post Content -->
                    <p>In the <a href="https://codewithstyle.info/typescript-discriminated-union-types">previous post</a> I’ve explained what <strong>discriminated unions</strong> are in the TypeScript language. We’ll now look into a classic example of how this concept can be applied to a real-world scenario - building an interpreter. <img src="https://codewithstyle.info/wp-content/uploads/2018/01/Precise-domain-modelling-with-discriminated-unions-—-kopia.png" alt=""></p>
<h2 id="Abstract-Syntax-Tree"><a href="#Abstract-Syntax-Tree" class="headerlink" title="Abstract Syntax Tree"></a>Abstract Syntax Tree</h2><p>By <em>interpreter</em> I mean a program that can execute source code of another program written in a different programming language. For example, JavaScript, PHP or Python are interpreted languages - you need an interpreter to run them. We will look into building an interpreter for a very simple <em>language</em> - algebraic expressions, such as:</p>
<pre><code>-5 * (1 + (3 / 6))
</code></pre><p>When building an interpreter (or a compiler) you need to build some data structures that represent the source code. These data structures form something called <strong>Abstract Syntax Tree</strong> (AST). It’s a tree-like structure because the source code usually involves lots of nesting. The AST of our example algebraic expression would look like this: <img src="https://codewithstyle.info/wp-content/uploads/2018/01/AST.png" alt=""> You can see that the tree structure corresponds to the order in which mathematical operations are applied. For example, <code>3 / 6</code> should be calculated first and that’s why it’s low in the tree. The multiplication will be evaluated at the very end and hence it’s the tree’s root. Discriminated unions are perfect for representing such a tree. Our AST has different kinds of nodes:</p>
<ul>
<li>binary operators - addition, subtraction, multiplication and division</li>
<li>unary operators - negation</li>
<li>numerical values</li>
</ul>
<p>Let’s create some types that correspond to these kinds.</p>
<pre><code>interface BinaryOperatorNode {
    kind: &quot;BinaryOperator&quot;;
    left: ExpressionNode;
    right: ExpressionNode;
    operator: &quot;+&quot; | &quot;*&quot; | &quot;-&quot; | &quot;/&quot;;
}

interface UnaryOperatorNode {
    kind: &quot;UnaryOperator&quot;,
    operator: &quot;+&quot; | &quot;-&quot;;
    inner: ExpressionNode;
}

interface NumberNode {
    kind: &quot;Number&quot;;
    value: number;
}

type ExpressionNode = BinaryOperatorNode | UnaryOperatorNode | NumberNode;
</code></pre><p>We’ve created the <code>ExpressionNode</code> discriminated union. It’s a union of three node kinds:</p>
<ul>
<li><code>NumberNode</code> is the simplest type - it contains a numerical value</li>
<li><code>BinaryOperatorNode</code> represents an operation on two expressions; the <code>operator</code> field determines what kind of operations it is; <code>left</code> and <code>right</code> fields contain arguments of the operation</li>
<li><code>UnaryOperatorNode</code> is like <code>BinaryOperatorNode</code> but only contains a single argument</li>
</ul>
<p>Interestingly, these types are <em>recursive</em> in a way. For example, <code>UnaryOperatorNode</code> has <code>inner</code> property which can be any <code>ExpressionNode</code> - indeed, we can negate a number, but also a much more complex expression wrapped in parenthesis.</p>
<h2 id="Evaluating-the-AST"><a href="#Evaluating-the-AST" class="headerlink" title="Evaluating the AST"></a>Evaluating the AST</h2><p>Now we have data structures in place there are only two questions left:</p>
<ul>
<li>How to create an AST from the source code? This is actually a task for a <strong>parser</strong>. Parsers are beyond the scope of this article. Interestingly, you can <strong>generate</strong> a parser using <a href="https://github.com/zaach/jison" target="_blank" rel="noopener">Jison</a> or some other tool.</li>
<li>How to evaluate the AST? Let’s look into this.</li>
</ul>
<p>We’ve already seen how to consume discriminated unions with a <code>switch</code> statement. This is no different here with the exception that since our types are recursive, the evaluation function will be recursive as well.</p>
<pre><code>function evaluate(expression: ExpressionNode): number {
    switch (expression.kind) {
        case &quot;Number&quot;: 
            return expression.value
</code></pre><p>The <code>evaluate</code> function takes an <code>ExpressionNode</code> object and evaluates it to a number. First, we check for an instance of <code>NumberNode</code> in which case the expression will simply evaluate to the value held by the object.</p>
<pre><code>case &quot;UnaryOperator&quot;:
    const innerValue = evaluate(expression.inner);
    return expression.operator === &quot;+&quot; ? innerValue : -innerValue;
</code></pre><p>For <code>UnaryOperatorNode</code> we need to evaluate the value of the nested expression first. That’s why we make a recursive call to <code>evaluate</code> itself. Once this is done we either negate or simply return it as it is.</p>
<pre><code>        case &quot;BinaryOperator&quot;:
            const leftValue = evaluate(expression.left);
            const rightValue = evaluate(expression.right);
            switch (expression.operator) {
                case &quot;+&quot;: return leftValue + rightValue;
                case &quot;-&quot;: return leftValue - rightValue;
                case &quot;*&quot;: return leftValue * rightValue;
                case &quot;/&quot;: return leftValue / rightValue;
            }
    }
}
</code></pre><p><code>BinaryOperatorNode</code> has two nested expression - <code>left</code> and <code>right</code> - so we need to evaluate both of them. Next, we use the relevant mathematical operation on them to calculate the final value. Here is the full source code of the <code>evaluate</code> function:</p>
<pre><code>function evaluate(expression: ExpressionNode): number {
    switch (expression.kind) {
        case &quot;Number&quot;: 
            return expression.value
        case &quot;UnaryOperator&quot;:
            const innerValue = evaluate(expression.inner);
            return expression.operator === &quot;+&quot; ? innerValue : -innerValue;
        case &quot;BinaryOperator&quot;:
            const leftValue = evaluate(expression.left);
            const rightValue = evaluate(expression.right);
            switch (expression.operator) {
                case &quot;+&quot;: return leftValue + rightValue;
                case &quot;-&quot;: return leftValue - rightValue;
                case &quot;*&quot;: return leftValue * rightValue;
                case &quot;/&quot;: return leftValue / rightValue;
            }
    }
}
</code></pre><p>Finally, we need an object instance for testing. Here is the <code>(42 + 5) * -12</code> expression represented as an AST:</p>
<pre><code>const expr1: ExpressionNode = {
    kind: &quot;BinaryOperator&quot;,
    operator: &quot;*&quot;,
    left: {
        kind: &quot;BinaryOperator&quot;,
        operator: &quot;+&quot;,
        left: {
            kind: &quot;Number&quot;,
            value: 42
        },
        right: {
            kind: &quot;Number&quot;,
            value: 5
        }
    },
    right: {
        kind: &quot;UnaryOperator&quot;,
        operator: &quot;-&quot;,
        inner: {
            kind: &quot;Number&quot;,
            value: 12
        }
    }
};
</code></pre><p>Now we can test our <code>evaluate</code> function:</p>
<pre><code>console.log(evaluate(expr1));
</code></pre><p>Voila, we’ve just finished our first interpreter written in TypeScript using discriminated unions.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>In this article, we’ve looked into taking advantage of discriminated unions in a non-trivial, real-world scenario - implementing a language interpreter. It’s easy to imagine how the types used to build an AST can be much more complex. For a real programming language, we would have to create types for statements, method calls, function declarations, etc. However, the principle would be roughly the same.</p>

                    
                    <!-- Tags Bottom -->
                    

                    <!-- Comments -->
                    



                </div>
                <div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50">
                    
                    <hr class="dn-l mw4 black-50 mt5">
                    
                    <div class="mt5 mt0-l">
    <article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3">
        <div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width: 6rem;">
            <img src="https://codewithstyle.info/wp-content/uploads/2017/02/miloszpiechocki.jpeg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="Miłosz Piechocki">
        </div>
        <div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">
            Hi! My name is Miłosz Piechocki. I’m a software developer living in Warsaw, Poland. I’m passionate about functional programming and in particular how it’s applied in modern web technologies.
        </div>
    </article>
</div>

                    <hr class="dn-l mw4 black-50 mt5">

                    <div class="mt5 tc tl-l">
    <h3>Download free e-book</h3>
    <p class="tj f6 lh-copy">Subscribe to receive updates about new posts and I will send you a link to a free e-book about functional programming in JavaScript.</p>
    <!-- Begin Mailchimp Signup Form -->
    <div id="mc_embed_signup">
        <form action="https://codewithstyle.us15.list-manage.com/subscribe/post?u=9387aca2477532e2e033cee17&amp;id=7c51853ca5" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
            <div id="mc_embed_signup_scroll">
                <div class="mc-field-group">
                    <input class="pa2 input-reset ba bg-transparent w-100" type="email" value="" name="EMAIL" id="mce-EMAIL" placeholder="enter your email">
                </div>
                <div id="mce-responses" class="clear">
                    <div class="response" id="mce-error-response" style="display:none"></div>
                    <div class="response" id="mce-success-response" style="display:none"></div>
                </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_9387aca2477532e2e033cee17_7c51853ca5" tabindex="-1" value=""></div>
                <div class="clear mt2">
                    <input class="b ph3 pv2 input-reset ba b--black bg-transparent grow pointer f6 dib" type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe">
                </div>
            </div>
        </form>
    </div>
    <!--End mc_embed_signup-->
</div>

                    
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Footer -->
<div class="bg-1 ph2 ph5-ns pv5">
        <div class="mv8">
            <div class="center tc">
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="http://twitter.com/miloszpp/" target="_blank">
                            <i class="fab fa-twitter"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="http://facebook.com/codewithstyle.info/" target="_blank">
                            <i class="fab fa-facebook"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://github.com/miloszpp" target="_blank">
                            <i class="fab fa-github"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://www.youtube.com/channel/UC_DEBDpgRyBZAT85tJ1QZBw" target="_blank">
                            <i class="fab fa-youtube"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="mailto:milosz@miloszpiechocki.com" target="_blank">
                            <i class="fas fa-envelope"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="/#" target="_blank">
                            <i class="fas fa-rss"></i>
                        </a>
                    </div>
                
            </div>
            <div class="f6 f5-ns center tc white pt5 fw3">
                @Copyright Miłosz Piechocki. All right reserved | Design & Hexo based on Anodyne by <a class="link dim white" href="http://www.codeblocq.com/">Jonathan Klughertz</a>
            </div>
        </div>
    </div>

<!-- After Footer -->
<!-- Disqus Comments -->



</body>

</html>